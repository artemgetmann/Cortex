{
  "id": "cli-sqlite-incremental-reconcile-v1",
  "task_match": {
    "all": [
      "sqlite"
    ],
    "any": [
      "reconcile",
      "incremental",
      "dedupe"
    ]
  },
  "setup": {
    "bootstrap_sql_path": "bootstrap.sql",
    "fixture_paths": [
      "fixture.csv"
    ]
  },
  "signals": {
    "required_sql_patterns": [
      "(?is)begin\\s+(transaction|immediate)",
      "(?is)commit",
      "(?is)insert\\s+into\\s+ledger",
      "(?is)insert\\s+into\\s+rejects",
      "(?is)checkpoint_log",
      "(?is)ckp-apr-01"
    ],
    "forbidden_sql_patterns": [
      "(?is)drop\\s+table\\s+ledger",
      "(?is)delete\\s+from\\s+ledger"
    ],
    "required_queries": [
      {
        "id": "ledger_aggregate",
        "sql": "SELECT category, SUM(amount) AS total FROM ledger GROUP BY category ORDER BY category;",
        "expected_rows": [
          [
            "bass",
            "4"
          ],
          [
            "drums",
            "13"
          ],
          [
            "lead",
            "3"
          ]
        ]
      },
      {
        "id": "reject_count",
        "sql": "SELECT COUNT(*) FROM rejects WHERE reason = 'duplicate_event';",
        "expected_rows": [
          [
            "1"
          ]
        ]
      },
      {
        "id": "checkpoint_row",
        "sql": "SELECT checkpoint_tag, row_count FROM checkpoint_log ORDER BY checkpoint_tag;",
        "expected_rows": [
          [
            "CKP-APR-01",
            "4"
          ]
        ]
      }
    ],
    "max_error_count": 1
  },
  "pass_rule": "all_required && no_forbidden && required_queries_match && errors_within_budget",
  "reason_codes": [
    "missing_required_pattern",
    "matched_forbidden_pattern",
    "required_query_mismatch",
    "too_many_errors"
  ]
}
